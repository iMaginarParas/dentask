<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>UC App Studio | WhatsApp Dash</title>
<script src="https://cdn.tailwindcss.com"></script>

<style>
.glass-card { background: rgba(255,255,255,.95); backdrop-filter: blur(10px); }
.loader { border-top-color:#2563eb; animation: spinner 1.5s linear infinite;}
@keyframes spinner {0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
</style>
</head>

<body class="bg-gray-50 min-h-screen flex flex-col items-center p-8">

<div class="w-full max-w-4xl flex justify-between items-center mb-10">
<h1 class="text-2xl font-bold">UC App Studio</h1>
<div id="status-badge" class="px-3 py-1 rounded-full bg-gray-200 text-xs">Disconnected</div>
</div>

<div id="login-section" class="glass-card p-8 rounded-xl text-center max-w-md w-full">
<h2 class="text-xl font-bold mb-4">Connect WhatsApp Business</h2>

<button onclick="launchWhatsAppSignup()" id="auth-btn"
class="w-full bg-[#1877F2] text-white py-3 rounded-xl">
Connect with Meta
</button>

<p id="error-msg" class="text-red-500 text-xs mt-3 hidden"></p>
</div>

<div id="dashboard-section" class="hidden w-full max-w-4xl mt-10">
<pre id="raw-output" class="bg-black text-green-400 p-4 text-xs"></pre>
</div>

<script>
const BACKEND_URL = "https://dentask-production.up.railway.app";
const CONFIG_ID = "846449218431910";

window.fbAsyncInit = function () {
    FB.init({
        appId: "1416504326619315",
        cookie: true,
        xfbml: true,
        version: "v22.0"
    });
};

function launchWhatsAppSignup() {

    FB.login(function(response) {

        if (response.authResponse) {
            exchangeCodeForToken(response.authResponse.code);
        } else {
            showError("User cancelled login");
        }

    }, {
        config_id: CONFIG_ID,
        response_type: "code",
        override_default_response_type: true,
        extras: { setup: {} }
    });
}

async function exchangeCodeForToken(code) {

    const res = await fetch(`${BACKEND_URL}/api/auth/whatsapp`, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ code })
    });

    const data = await res.json();
    handleSuccess(data);
}

/* Capture embedded signup result */
window.addEventListener("message", async function(event){

    if(!event.origin.includes("facebook.com")) return;

    try {
        const data = JSON.parse(event.data);

        if(data.type === "WA_EMBEDDED_SIGNUP" &&
          (data.event === "FINISH" || data.event === "FINISH_ONLY_WABA")) {

            const {phone_number_id, waba_id} = data.data;

            await fetch(`${BACKEND_URL}/api/store-waba`, {
                method: "POST",
                headers: {"Content-Type":"application/json"},
                body: JSON.stringify({phone_number_id, waba_id})
            });

        }

    } catch(e){}
});

function handleSuccess(data) {

    document.getElementById("status-badge").innerText = "Connected";
    document.getElementById("login-section").style.display="none";
    document.getElementById("dashboard-section").style.display="block";
    document.getElementById("raw-output").innerText =
        JSON.stringify(data,null,2);
}

function showError(msg){
    const el=document.getElementById("error-msg");
    el.innerText=msg;
    el.classList.remove("hidden");
}
</script>

<script async defer crossorigin="anonymous"
src="https://connect.facebook.net/en_US/sdk.js"></script>

</body>
</html>
